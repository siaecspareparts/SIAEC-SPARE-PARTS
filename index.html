function doGet(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const action = e.parameter.action;
  const callback = e.parameter.callback;

  function respond(data) {
    const json = JSON.stringify(data);
    if (callback) {
      return ContentService.createTextOutput(callback + '(' + json + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    return ContentService.createTextOutput(json)
      .setMimeType(ContentService.MimeType.JSON);
  }

  if (action === 'getData') {
    const employees = ss.getSheetByName("EmployeeData").getDataRange().getValues();
    const equipment = ss.getSheetByName("EquipmentNumber").getDataRange().getValues();
    const parts = ss.getSheetByName("Kalmar").getDataRange().getValues();
    const result = { employees: [], equipment: [], parts: [] };
    for (let i = 1; i < employees.length; i++) {
      if (employees[i][0]) result.employees.push({
        name: String(employees[i][0]),
        staffNumber: String(employees[i][1])
      });
    }
    for (let i = 1; i < equipment.length; i++) {
      if (equipment[i][1]) result.equipment.push({
        equipmentNumber: String(equipment[i][1]),
        vehicleType: String(equipment[i][0])
      });
    }
    for (let i = 1; i < parts.length; i++) {
      if (parts[i][0]) result.parts.push({
        partNumber: String(parts[i][0]),
        partName: String(parts[i][1]),
        vehicleType: String(parts[i][2]),
        altPartNumber: String(parts[i][3] || '')
      });
    }
    return respond(result);
  }

  if (action === 'cancel') {
    const sheet = ss.getSheetByName("Form Output");
    const rows = sheet.getDataRange().getValues();
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][0] === e.parameter.requestId) {
        sheet.getRange(i+1, 12).setValue('Cancelled'); // column 12 = Status
        break;
      }
    }
    return respond({ status: 'ok' });
  }

  // Default: save form submission
  const sheet = ss.getSheetByName("Form Output");
  const p = e.parameter;
  sheet.appendRow([
    p.requestId,       // A - RequestID
    p.jobCardNumber,   // B - JobCardNumber
    p.employeeName,    // C - EmployeeName
    p.staffNumber,     // D - StaffNumber
    p.submitterEmail,  // E - SubmitterEmail â† FIXED
    p.equipmentNumber, // F - EquipmentNumber
    p.vehicleType,     // G - VehicleType
    p.partNumber,      // H - PartNumber
    p.partName,        // I - Description
    p.quantityNumber,  // J - QuantityNumber
    p.timestamp,       // K - Timestamp
    'Pending'          // L - Status
  ]);
  return respond({ status: 'ok' });
}
