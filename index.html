<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Spare Parts Request â€” SIAEC</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --navy: #0d2b5e; --navy-light: #1a3d7c; --navy-dark: #071a3e;
    --gold: #c9a84c; --gold-light: #e2c97e; --gold-dark: #a8882e;
    --white: #ffffff; --off-white: #f4f6fa; --light-blue: #dce8f5;
    --text-dark: #0d1f3c; --text-mid: #4a5568;
    --success: #22c55e; --danger: #ef4444;
    --border: #c8d8ee; --shadow-sm: 0 2px 8px rgba(13,43,94,0.08);
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy) 50%, #143566 100%);
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    padding: 24px 12px;
  }
  .card { width: 100%; max-width: 480px; background: var(--white); border-radius: 20px; overflow: hidden; box-shadow: 0 24px 80px rgba(7,26,62,0.5); animation: cardIn 0.6s cubic-bezier(0.16,1,0.3,1) both; }
  @keyframes cardIn { from{opacity:0;transform:translateY(28px) scale(0.97)} to{opacity:1;transform:translateY(0) scale(1)} }
  .header { background: linear-gradient(135deg, var(--navy-dark) 0%, var(--navy-light) 100%); padding: 22px 24px 18px; display: flex; align-items: center; gap: 14px; border-bottom: 3px solid var(--gold); }
  .header-text h1 { font-family: 'Playfair Display', serif; font-size: 17px; color: var(--white); }
  .header-text p { font-size: 11px; color: var(--gold-light); letter-spacing: 1.4px; text-transform: uppercase; }
  .user-badge { display: none; align-items: center; gap: 8px; background: rgba(255,255,255,0.1); border-radius: 50px; padding: 5px 12px; margin-left: auto; }
  .user-badge.visible { display: flex; }
  .user-avatar-placeholder { width: 26px; height: 26px; border-radius: 50%; background: var(--gold); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--navy-dark); }
  .sign-out-btn { background: none; border: none; cursor: pointer; color: var(--gold-light); font-size: 10px; text-decoration: underline; }
  #loginPanel { padding: 48px 32px; display: flex; flex-direction: column; align-items: center; gap: 20px; background: var(--off-white); }
  .login-icon { width: 64px; height: 64px; background: var(--navy); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--gold-light); font-size: 30px; }
  .google-btn { display: flex; align-items: center; gap: 10px; background: white; border: 1.5px solid var(--border); border-radius: 50px; padding: 12px 24px; cursor: pointer; font-family: inherit; font-weight: 500; }
  .form-body { padding: 20px 22px 24px; background: var(--off-white); }
  .field-group { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
  .field { display: grid; grid-template-columns: 140px 1fr; border-radius: 10px; border: 1px solid var(--border); background: white; overflow: visible; }
  .field-label { background: var(--navy); color: var(--white); font-size: 11px; padding: 10px; border-radius: 10px 0 0 10px; display: flex; align-items: center; }
  .field-input input { width: 100%; border: none; outline: none; padding: 10px; font-size: 13px; }
  .field-input input[readonly] { background: #eee; cursor: not-allowed; }
  .combo-wrap { position: relative; }
  .combo-list { position: absolute; top: 100%; left: -140px; width: calc(100% + 140px); background: white; border: 1px solid var(--gold); border-radius: 8px; z-index: 99; max-height: 200px; overflow-y: auto; display: none; box-shadow: var(--shadow-sm); }
  .combo-list.open { display: block; }
  .combo-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
  .combo-item:hover { background: var(--light-blue); }
  .btn-submit { background: var(--gold); color: var(--navy-dark); width: 100%; padding: 14px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; margin-top: 10px; }
  #successPanel { display: none; flex-direction: column; align-items: center; padding: 40px; text-align: center; }
  .request-id { background: var(--light-blue); padding: 8px 20px; border-radius: 8px; font-weight: 600; margin: 20px 0; }
  .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; color: white; flex-direction: column; gap: 10px; }
  .spinner { width: 30px; height: 30px; border: 3px solid #fff3; border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--danger); color: white; padding: 10px 20px; border-radius: 20px; display: none; }
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div id="loadingText">Loading Data...</div>
</div>

<div class="card">
  <div class="header">
    <div class="header-text">
      <h1>Spare Parts Request</h1>
      <p>SIA Engineering Company</p>
    </div>
    <div class="user-badge" id="userBadge">
      <div class="user-avatar-placeholder" id="userInitial">?</div>
      <button class="sign-out-btn" onclick="signOut()">Sign out</button>
    </div>
  </div>

  <div id="loginPanel">
    <div class="login-icon">ðŸ‘¤</div>
    <div class="login-title">Staff Portal</div>
    <button class="google-btn" onclick="handleGoogleSignIn()">Sign in with Google</button>
  </div>

  <div id="formPanel" style="display:none;">
    <div class="form-body">
      <form id="requestForm">
        <div class="field-group">
          <div class="field"><div class="field-label">Job Card #</div><div class="field-input"><input type="text" id="jobCardNumber" required></div></div>
          
          <div class="field">
            <div class="field-label">Employee</div>
            <div class="field-input combo-wrap">
              <input type="text" id="employeeName" placeholder="Search name..." autocomplete="off">
              <div class="combo-list" id="list-emp"></div>
            </div>
          </div>
          
          <div class="field"><div class="field-label">Staff No.</div><div class="field-input"><input type="text" id="staffNumber" readonly></div></div>
          <div class="field"><div class="field-label">Email</div><div class="field-input"><input type="text" id="submitterEmail" readonly></div></div>
          
          <div class="field">
            <div class="field-label">Equipment</div>
            <div class="field-input combo-wrap">
              <input type="text" id="equipmentNumber" placeholder="Search equipment..." autocomplete="off">
              <div class="combo-list" id="list-equ"></div>
            </div>
          </div>

          <div class="field"><div class="field-label">Vehicle Type</div><div class="field-input"><input type="text" id="vehicleType" readonly></div></div>

          <div class="field">
            <div class="field-label">Part No.</div>
            <div class="field-input combo-wrap">
              <input type="text" id="partNumber" placeholder="Search part..." autocomplete="off">
              <div class="combo-list" id="list-part"></div>
            </div>
          </div>

          <div class="field"><div class="field-label">Part Name</div><div class="field-input"><input type="text" id="partName" readonly></div></div>
          <div class="field"><div class="field-label">Quantity</div><div class="field-input"><input type="number" id="quantityNumber" value="1" min="1"></div></div>
        </div>
        <button type="submit" class="btn-submit" id="submitBtn">Submit Request</button>
      </form>
    </div>
  </div>

  <div id="successPanel">
    <div style="font-size: 50px; color: var(--success);">âœ“</div>
    <h2>Submitted Successfully</h2>
    <div class="request-id" id="requestIdDisplay">SPR-000000</div>
    <button class="btn-submit" onclick="location.reload()">New Request</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwf4-YicW6od4nMTPya_8akVjkS0XhvdmjpuLXBgAJinI-g9aiGTpk9jb7mFJz9HyjTtA/exec"; 
const GOOGLE_CLIENT_ID = "961625730687-tr6kh5tj8tdninriurqf2scribl1one9.apps.googleusercontent.com";

let appData = { employees: [], equipment: [], parts: [] };
let currentUser = { email: '', name: '' };

// 1. SIGN IN LOGIC
function handleGoogleSignIn() {
  const client = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'email profile',
    callback: (response) => {
      if (response.access_token) {
        fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
          headers: { Authorization: 'Bearer ' + response.access_token }
        })
        .then(r => r.json())
        .then(user => {
          currentUser.email = user.email;
          currentUser.name = user.name || user.email;
          onSignedIn();
        });
      }
    }
  });
  client.requestAccessToken();
}

function onSignedIn() {
  document.getElementById('userInitial').textContent = currentUser.name.charAt(0).toUpperCase();
  document.getElementById('userBadge').classList.add('visible');
  document.getElementById('submitterEmail').value = currentUser.email;
  document.getElementById('loginPanel').style.display = 'none';
  fetchData(); // THIS IS THE KEY MISSING STEP
}

// 2. FETCH DATA FROM GOOGLE SHEETS
function fetchData() {
  const overlay = document.getElementById('loadingOverlay');
  overlay.style.display = 'flex';

  fetch(`${APPS_SCRIPT_URL}?action=getData`)
    .then(r => r.json())
    .then(data => {
      appData = data;
      initCombos();
      overlay.style.display = 'none';
      document.getElementById('formPanel').style.display = 'block';
    })
    .catch(err => {
      console.error(err);
      overlay.style.display = 'none';
      alert("Error loading sheet data. Ensure the URL is correct and shared.");
    });
}

// 3. COMBO DROPDOWN LOGIC
function setupCombo(inputId, listId, filterFn, onSelect) {
  const inp = document.getElementById(inputId);
  const lst = document.getElementById(listId);

  inp.addEventListener('input', () => {
    const q = inp.value.toLowerCase();
    const matches = filterFn(q);
    lst.innerHTML = matches.map(m => `<div class="combo-item" data-id="${m.id}">${m.text}</div>`).join('');
    lst.classList.toggle('open', matches.length > 0);
  });

  lst.addEventListener('mousedown', (e) => {
    if (e.target.classList.contains('combo-item')) {
      const selected = filterFn('').find(x => x.id === e.target.dataset.id);
      inp.value = e.target.innerText;
      lst.classList.remove('open');
      onSelect(selected);
    }
  });

  inp.addEventListener('blur', () => setTimeout(() => lst.classList.remove('open'), 200));
}

function initCombos() {
  // Employee Combo
  setupCombo('employeeName', 'list-emp', 
    (q) => appData.employees.filter(e => e.name.toLowerCase().includes(q)).map(e => ({id: e.staffNumber, text: e.name, raw: e})),
    (item) => document.getElementById('staffNumber').value = item.raw.staffNumber
  );

  // Equipment Combo
  setupCombo('equipmentNumber', 'list-equ', 
    (q) => appData.equipment.filter(e => e.equipmentNumber.toLowerCase().includes(q)).map(e => ({id: e.equipmentNumber, text: e.equipmentNumber, raw: e})),
    (item) => document.getElementById('vehicleType').value = item.raw.vehicleType
  );

  // Parts Combo
  setupCombo('partNumber', 'list-part', 
    (q) => appData.parts.filter(p => p.partNumber.toLowerCase().includes(q)).map(p => ({id: p.partNumber, text: p.partNumber, raw: p})),
    (item) => document.getElementById('partName').value = item.raw.partName
  );
}

// 4. SUBMIT FORM
document.getElementById('requestForm').onsubmit = function(e) {
  e.preventDefault();
  const btn = document.getElementById('submitBtn');
  btn.disabled = true;
  btn.innerText = "Submitting...";

  const requestId = "SPR-" + Date.now().toString().slice(-6);
  const params = new URLSearchParams({
    requestId: requestId,
    jobCardNumber: document.getElementById('jobCardNumber').value,
    employeeName: document.getElementById('employeeName').value,
    staffNumber: document.getElementById('staffNumber').value,
    submitterEmail: currentUser.email,
    equipmentNumber: document.getElementById('equipmentNumber').value,
    vehicleType: document.getElementById('vehicleType').value,
    partNumber: document.getElementById('partNumber').value,
    partName: document.getElementById('partName').value,
    quantityNumber: document.getElementById('quantityNumber').value
  });

  fetch(`${APPS_SCRIPT_URL}?${params.toString()}`, { method: 'POST' })
    .then(r => r.json())
    .then(res => {
      document.getElementById('formPanel').style.display = 'none';
      document.getElementById('successPanel').style.display = 'flex';
      document.getElementById('requestIdDisplay').innerText = requestId;
    })
    .catch(err => {
      alert("Submit failed. Check console.");
      btn.disabled = false;
      btn.innerText = "Submit Request";
    });
};

function signOut() { location.reload(); }
</script>
</body>
</html>
